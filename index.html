<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹å¼ç¢¼å·¦å³æ¯”å°å·¥å…· (å¯ç·¨è¼¯ç‰ˆ)</title>
    <!-- å¼•å…¥ jsdiff å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        /* èª¿æ•´æ¨™é¡Œæ¨£å¼ï¼Œé ç•™ç©ºé–“çµ¦æŒ‰éˆ• */
        h2 { 
            text-align: center; 
            color: #444; 
            margin-bottom: 10px;
        }

        /* è¼¸å…¥å€åŸŸæ¨£å¼ */
        .input-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            resize: vertical;
        }
        
        /* ç§»é™¤èˆŠç‰ˆæ§åˆ¶é …æ¨£å¼ */
        .controls { display: none; }

        /* --- æ¯”å°çµæœè¡¨æ ¼æ¨£å¼ --- */
        .diff-view {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .diff-view th {
            background-color: #f1f1f1;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        .diff-view td {
            padding: 0;
            vertical-align: top;
            line-height: 1.5;
            border-bottom: 1px solid #eee;
        }

        /* ç¨‹å¼ç¢¼å…§å®¹ (å¯ç·¨è¼¯) */
        .code-text {
            white-space: pre-wrap;
            word-break: break-all;
            padding: 2px 5px;
            min-height: 20px;
            outline: none;
            cursor: text;
        }
        
        .code-text:focus {
            background-color: #fffde7;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.2);
        }

        /* è¡Œè™Ÿæ¨£å¼ */
        .line-num {
            text-align: right;
            padding: 0 5px;
            color: #999;
            background-color: #fcfcfc;
            border-right: 1px solid #eee;
            user-select: none;
            white-space: nowrap;
        }

        /* --- å·®ç•°æ¨™ç¤ºæ¨£å¼ --- */
        .del-bg {
            background-color: #ffeef0;
            color: #b30000;
        }
        
        .add-bg {
            background-color: #e6ffec;
            color: #008000;
            font-weight: bold;
        }

        .del-bg:focus { background-color: #ffdce0; }
        .add-bg:focus { background-color: #d1ffdb; }

        .empty-placeholder {
            background-color: #f8f8f8;
            background-image: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 10px, #f9f9f9 10px, #f9f9f9 20px);
            cursor: default;
        }
        
        /* ç‹€æ…‹åˆ—èˆ‡å·¥å…·åˆ— */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background-color: #f1f1f1;
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .status-bar {
            font-size: 12px;
            color: #666;
            flex-grow: 1;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .btn:hover {
            background-color: #e9e9e9;
            border-color: #bbb;
        }

        .btn-primary {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .btn-primary:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        /* æ–°å¢ï¼šé‡ç½®æŒ‰éˆ•å°ˆç”¨æ¨£å¼ */
        .btn-reset {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
            margin: 0 auto; /* ç½®ä¸­ */
        }
        .btn-reset:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        /* é ‚éƒ¨é‡ç½®æŒ‰éˆ•å€åŸŸ */
        .top-controls {
            text-align: center;
            margin-bottom: 20px;
        }

    </style>
</head>
<body>

    <h2>ç¨‹å¼ç¢¼ç‰ˆæœ¬æ¯”å° (å¯ç·¨è¼¯ + åŒ¯å‡º)</h2>

    <!-- æ–°å¢ï¼šé ‚éƒ¨é‡ç½®æŒ‰éˆ• -->
    <div class="top-controls">
        <button class="btn btn-reset" onclick="resetAll()">
            ğŸ”„ æ¸…ç©º / é‡æ–°é–‹å§‹æ¯”å°
        </button>
    </div>

    <div class="input-container">
        <div class="input-group">
            <label>åŸå§‹ç‰ˆæœ¬ (Original)</label>
            <textarea id="oldCode" oninput="handleTextareaInput()" placeholder="è«‹è²¼ä¸ŠåŸå§‹ç¨‹å¼ç¢¼...">function calculateTotal(price, tax) {
  let total = price + tax;
  console.log("Calculating...");
  return total;
}

function unusedFunction() {
  // é€™æ˜¯èˆŠçš„å‡½å¼
  return null;
}</textarea>
        </div>
        <div class="input-group">
            <label>æ–°ç‰ˆæœ¬ (New Version)</label>
            <textarea id="newCode" oninput="handleTextareaInput()" placeholder="è«‹è²¼ä¸Šæ–°ç‰ˆç¨‹å¼ç¢¼...">function calculateTotal(price, tax) {
  // ä¿®æ­£ç¨…ç‡è¨ˆç®—é‚è¼¯
  let total = price * (1 + tax);
  console.log("Total calculated: " + total);
  return total;
}

function newFeature() {
  console.log("é€™æ˜¯æ–°åŠŸèƒ½");
}</textarea>
        </div>
    </div>

    <!-- å·¥å…·åˆ— -->
    <div class="toolbar">
        <div class="status-bar" id="statusBar">ğŸ’¡ æç¤ºï¼šå¯ç›´æ¥ä¿®æ”¹ä¸‹æ–¹å³å´è¡¨æ ¼å…§å®¹ï¼Œç³»çµ±å°‡è‡ªå‹•åŒæ­¥ã€‚</div>
        <div class="action-buttons">
            <button class="btn" onclick="copyNewCode()">
                ğŸ“‹ è¤‡è£½æ–°ç‰ˆ(å³å´)ç¨‹å¼ç¢¼
            </button>
            <button class="btn btn-primary" onclick="downloadNewCode()">
                â¬‡ï¸ åŒ¯å‡ºæ–°ç‰ˆæª”æ¡ˆ
            </button>
        </div>
    </div>

    <!-- æ¯”å°çµæœå°‡ç”Ÿæˆåœ¨é€™è£¡ -->
    <table class="diff-view" id="diffTable">
        <colgroup>
            <col style="width: 1%;">
            <col style="width: 49%;">
            <col style="width: 1%;">
            <col style="width: 49%;">
        </colgroup>
        <thead>
            <tr>
                <th colspan="2">åŸå§‹ç¨‹å¼ç¢¼</th>
                <th colspan="2" style="background-color: #e6ffec;">æ–°ç‰ˆç¨‹å¼ç¢¼ (å¯ç·¨è¼¯)</th>
            </tr>
        </thead>
        <tbody id="diffBody">
            <!-- JS å‹•æ…‹æ’å…¥å…§å®¹ -->
        </tbody>
    </table>

    <script>
        let debounceTimer;
        
        // æ–°å¢ï¼šé‡ç½®/æ¸…ç©ºåŠŸèƒ½
        function resetAll() {
            if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿé€™å°‡ç§»é™¤ç›®å‰çš„æ¯”å°çµæœã€‚")) {
                document.getElementById('oldCode').value = '';
                document.getElementById('newCode').value = '';
                renderDiff(); // é‡æ–°æ¸²æŸ“ï¼ˆæ¸…ç©ºè¡¨æ ¼ï¼‰
                
                // æ›´æ–°ç‹€æ…‹æç¤º
                const statusBar = document.getElementById('statusBar');
                statusBar.textContent = "âœ¨ å·²æ¸…ç©ºï¼Œè«‹åœ¨ä¸Šæ–¹è²¼ä¸Šæ–°çš„ç¨‹å¼ç¢¼ä»¥é–‹å§‹æ¯”å°ã€‚";
                statusBar.style.color = "#0056b3";
            }
        }

        // è™•ç†ä¸Šæ–¹ Textarea è¼¸å…¥ (å³æ™‚æ›´æ–°)
        function handleTextareaInput() {
            renderDiff();
        }

        // è™•ç†ä¸‹æ–¹è¡¨æ ¼è¼¸å…¥ (åå‘åŒæ­¥ + é˜²æŠ–å‹•)
        function setupTableInputListeners() {
            const table = document.getElementById('diffBody');
            if (!table) return; // é˜²å‘†
            
            table.removeEventListener('input', onTableInput);
            table.addEventListener('input', onTableInput);
        }

        function onTableInput(e) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = "âœï¸ è¼¸å…¥ä¸­... (åœæ­¢æ‰“å­— 1 ç§’å¾Œæ›´æ–°æ¯”å°)";
            statusBar.style.color = "#0056b3";

            clearTimeout(debounceTimer);
            syncTableToTextarea();

            debounceTimer = setTimeout(() => {
                renderDiff();
                statusBar.textContent = "âœ… å·²æ›´æ–°æ¯”å°çµæœ";
                statusBar.style.color = "green";
                
                setTimeout(() => { 
                    statusBar.textContent = "ğŸ’¡ æç¤ºï¼šå¯ç›´æ¥ä¿®æ”¹ä¸‹æ–¹å³å´è¡¨æ ¼å…§å®¹ï¼Œç³»çµ±å°‡è‡ªå‹•åŒæ­¥ã€‚"; 
                    statusBar.style.color = "#666";
                }, 3000);
            }, 1000); 
        }

        function syncTableToTextarea() {
            const rows = document.querySelectorAll('#diffBody tr');
            let leftLines = [];
            let rightLines = [];

            rows.forEach(row => {
                const leftCell = row.cells[1];
                if (leftCell && !leftCell.classList.contains('empty-placeholder')) {
                    leftLines.push(leftCell.innerText); 
                }

                const rightCell = row.cells[3];
                if (rightCell && !rightCell.classList.contains('empty-placeholder')) {
                    rightLines.push(rightCell.innerText);
                }
            });

            document.getElementById('oldCode').value = leftLines.join('\n').replace(/\r\n/g, '\n').replace(/\n\n/g, '\n'); 
            document.getElementById('newCode').value = rightLines.join('\n').replace(/\r\n/g, '\n').replace(/\n\n/g, '\n');
        }

        function copyNewCode() {
            syncTableToTextarea();
            const content = document.getElementById('newCode').value;
            
            const tempInput = document.createElement("textarea");
            tempInput.value = content;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            
            const btn = document.querySelector('.action-buttons .btn'); 
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… å·²è¤‡è£½ï¼';
            setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        }

        function downloadNewCode() {
            syncTableToTextarea();
            const content = document.getElementById('newCode').value;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'updated_code.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function renderDiff() {
            const oldStr = document.getElementById('oldCode').value;
            const newStr = document.getElementById('newCode').value;
            const diffBody = document.getElementById('diffBody');
            
            const diff = Diff.diffLines(oldStr, newStr);

            diffBody.innerHTML = '';

            let diffRows = [];
            diff.forEach(part => {
                let lines = part.value.split('\n');
                if (lines[lines.length - 1] === '') lines.pop();

                if (part.added) {
                    lines.forEach(line => diffRows.push({ type: 'added', content: line }));
                } else if (part.removed) {
                    lines.forEach(line => diffRows.push({ type: 'removed', content: line }));
                } else {
                    lines.forEach(line => diffRows.push({ type: 'common', content: line }));
                }
            });

            let outputRows = [];
            let tempLeft = [];
            let tempRight = [];

            function flushChanges() {
                const maxLen = Math.max(tempLeft.length, tempRight.length);
                for (let i = 0; i < maxLen; i++) {
                    const leftContent = tempLeft[i] || null;
                    const rightContent = tempRight[i] || null;
                    outputRows.push({ left: leftContent, right: rightContent });
                }
                tempLeft = [];
                tempRight = [];
            }

            diff.forEach(part => {
                let lines = part.value.split('\n');
                if (lines[lines.length - 1] === '') lines.pop();

                if (part.removed) {
                    lines.forEach(line => tempLeft.push(line));
                } else if (part.added) {
                    lines.forEach(line => tempRight.push(line));
                } else {
                    flushChanges(); 
                    lines.forEach(line => {
                        outputRows.push({ left: line, right: line, common: true });
                    });
                }
            });
            flushChanges();

            let oldLineNum = 1;
            let newLineNum = 1;

            outputRows.forEach(row => {
                const tr = document.createElement('tr');

                // å·¦å´
                const tdLeftNum = document.createElement('td');
                tdLeftNum.className = 'line-num';
                const tdLeftCode = document.createElement('td');
                tdLeftCode.className = 'code-text';
                
                tdLeftCode.setAttribute('contenteditable', 'true');
                tdLeftCode.setAttribute('spellcheck', 'false'); 

                if (row.left !== null) {
                    tdLeftNum.textContent = oldLineNum++;
                    tdLeftCode.textContent = row.left;
                    if (!row.common && row.right === null) {
                        tdLeftCode.classList.add('del-bg');
                    } else if (!row.common && row.right !== null) {
                         tdLeftCode.classList.add('del-bg');
                    }
                } else {
                    tdLeftCode.classList.add('empty-placeholder');
                    tdLeftCode.removeAttribute('contenteditable'); 
                }

                // å³å´
                const tdRightNum = document.createElement('td');
                tdRightNum.className = 'line-num';
                const tdRightCode = document.createElement('td');
                tdRightCode.className = 'code-text';
                
                tdRightCode.setAttribute('contenteditable', 'true');
                tdRightCode.setAttribute('spellcheck', 'false');

                if (row.right !== null) {
                    tdRightNum.textContent = newLineNum++;
                    tdRightCode.textContent = row.right;
                    if (!row.common) {
                        tdRightCode.classList.add('add-bg');
                    }
                } else {
                    tdRightCode.classList.add('empty-placeholder');
                    tdRightCode.removeAttribute('contenteditable');
                }

                tr.appendChild(tdLeftNum);
                tr.appendChild(tdLeftCode);
                tr.appendChild(tdRightNum);
                tr.appendChild(tdRightCode);
                diffBody.appendChild(tr);
            });

            setupTableInputListeners();
        }

        window.onload = renderDiff;
    </script>

</body>
</html>
